vmType: "vz"
images:
- location: "https://cloud-images.ubuntu.com/questing/current/questing-server-cloudimg-arm64.img"
  arch: "aarch64"
- location: "https://cloud-images.ubuntu.com/questing/current/questing-server-cloudimg-amd64.img"
  arch: "x86_64"

cpus: 8
memory: 16GiB
disk: 100GiB

mountType: "virtiofs"
mounts:
- location: "{{.Home}}/code"
  writable: true
- location: "{{.Home}}/Downloads"
  writable: true
- location: "{{.Home}}/scratch"
  writable: true

rosetta:
  enabled: true
  binfmt: true

timezone: "America/Los_Angeles"

networks:
- vzNAT: true
  metric: 250

ssh:
  localPort: 6666
  loadDotSSHPubKeys: true

video:
  display: "vz"

# audio:
#   enabled: vz

containerd:
  system: false
  user: false

provision:
- mode: system
  script: |
    #!/bin/sh
    sed -i 's/host.lima.internal.*/host.lima.internal host.docker.internal/' /etc/hosts

- mode: system
  script: |
    #!/bin/bash
    set -e
    echo "Installing Docker..."
    if command -v docker >/dev/null 2>&1; then
        echo "Docker already installed"
        exit 0
    fi

    export DEBIAN_FRONTEND=noninteractive
    curl -fsSL https://get.docker.com | sh
    echo "Docker installed successfully"
    systemctl enable docker
    systemctl start docker
    echo "Docker service started"

    # Ensure Docker socket has proper permissions for Lima forwarding
    sleep 2
    if [ -S /var/run/docker.sock ]; then
        chmod 666 /var/run/docker.sock
        echo "Docker socket permissions set for forwarding"
    else
        echo "Warning: Docker socket not found at /var/run/docker.sock"
    fi

- mode: user
  script: |
    #!/usr/bin/bash
    sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply trodemaster

hostResolver:
  hosts:
    host.docker.internal: host.lima.internal

portForwards:
#- guestPortRange: [ 1, 65535 ]
#  hostIP: 0.0.0.0
- guestSocket: "/var/run/docker.sock"
  hostSocket: "{{.Dir}}/sock/docker.sock"

message: |
  To run `docker` on the host (assumes docker-cli is installed), run the following commands:
  ------
  docker context create lima --docker "host=unix://{{.Dir}}/sock/docker.sock"
  docker context use lima
  docker run --rm -ti --platform linux/amd64 ubuntu:latest
  ------
